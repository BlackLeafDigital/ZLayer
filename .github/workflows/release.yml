name: Release

on:
  repository_dispatch:
    types: [create-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.9.6 or v0.9.6)'
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup version
        id: version
        run: |
          # Handle both workflow_dispatch and repository_dispatch
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            INPUT_VERSION="${{ github.event.client_payload.version }}"
          else
            INPUT_VERSION="${{ inputs.version }}"
          fi
          # Extract numeric version (strip v prefix if present)
          VERSION_NUM=$(echo "$INPUT_VERSION" | sed 's/^v//')
          # Tag always has v prefix
          TAG="v${VERSION_NUM}"

          echo "version=${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION_NUM}, Tag: ${TAG}"

      - name: Download all artifacts from Forgejo
        run: |
          mkdir -p artifacts
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://forge.blackleafdigital.com/api/packages/BlackLeafDigital/generic/zlayer/${VERSION}"

          echo "Downloading from: ${BASE_URL}"

          # Download zlayer binary for all platforms
          for os in linux darwin; do
            for arch in amd64 arm64; do
              artifact="zlayer-${os}-${arch}.tar.gz"
              output="artifacts/zlayer-${VERSION}-${os}-${arch}.tar.gz"
              echo "Downloading ${artifact}..."
              curl -fsSL "${BASE_URL}/${artifact}" -o "${output}" && echo "  OK ${artifact}" || echo "  SKIP ${artifact} not available"
            done
          done

          # Download container image archives (OCI format only)
          for img in zlayer-node zlayer-manager; do
            artifact="${img}-${VERSION}-oci.tar"
            echo "Downloading ${artifact}..."
            curl -fsSL "${BASE_URL}/${artifact}" -o "artifacts/${artifact}" && echo "  ✓ ${artifact}" || echo "  ✗ ${artifact} not available"
          done

          echo ""
          echo "Downloaded artifacts:"
          ls -la artifacts/

      - name: Create or update tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          git tag -f "${TAG}"
          git push origin "${TAG}" --force

      - name: Delete existing release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ steps.version.outputs.tag }}" --yes 2>/dev/null || echo "No existing release to delete"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Build release notes
          cat > release_notes.md << 'EOF'
          ## Install

          ```bash
          # Install zlayer (unified binary: TUI, CLI, runtime, builder)
          curl -sSL https://raw.githubusercontent.com/BlackLeafDigital/ZLayer/main/install.sh | sh
          ```

          ## Binary

          | Binary | Description |
          |--------|-------------|
          | `zlayer` | Unified binary — TUI dashboard, full CLI, runtime, and image builder |

          ## Container Images

          **Docker Hub** (`zachhandley/`):
          ```bash
          docker pull zachhandley/zlayer-node:VERSION_PLACEHOLDER
          docker pull zachhandley/zlayer-manager:VERSION_PLACEHOLDER
          ```

          **GHCR** (`ghcr.io/blackleafdigital/`):
          ```bash
          docker pull ghcr.io/blackleafdigital/zlayer-node:VERSION_PLACEHOLDER
          docker pull ghcr.io/blackleafdigital/zlayer-manager:VERSION_PLACEHOLDER
          ```

          ## Using with ZLayer

          ```bash
          # Initialize and deploy zlayer-manager
          zlayer manager init
          zlayer deploy zlayer-manager.yaml

          # Or pull images directly
          zlayer pull zachhandley/zlayer-node:VERSION_PLACEHOLDER
          ```

          See the [CHANGELOG](https://github.com/BlackLeafDigital/ZLayer/blob/main/CHANGELOG.md) for details.
          EOF

          # Replace version placeholder
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" release_notes.md

          # Create the release with all artifacts
          gh release create "${TAG}" \
            --title "ZLayer ${VERSION}" \
            --notes-file release_notes.md \
            --latest \
            artifacts/*.tar.gz artifacts/*.tar 2>/dev/null || \
          gh release create "${TAG}" \
            --title "ZLayer ${VERSION}" \
            --notes-file release_notes.md \
            --latest \
            artifacts/*.tar.gz

          echo "✓ Release ${TAG} created successfully"
