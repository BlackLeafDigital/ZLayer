name: E2E Tests

on:
  repository_dispatch:
    types: [run-e2e-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0) - triggers release if provided'
        required: false
        type: string
      sha:
        description: 'Commit SHA to test'
        required: false
        type: string

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: "0"

jobs:
  # ===========================================
  # E2E Tests (Youki/libcontainer)
  # ===========================================
  e2e-tests:
    name: E2E Tests (Youki)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha || inputs.sha || github.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libseccomp-dev

      - name: Setup E2E environment
        run: |
          sudo rm -rf /tmp/zlayer-youki-e2e-test 2>/dev/null || true
          mkdir -p /tmp/zlayer-youki-e2e-test/{state,rootfs,bundles,cache}

      - name: Run E2E tests
        run: sudo -E env "PATH=$PATH" cargo test --package zlayer-agent --test youki_e2e -- --nocapture
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf /var/lib/zlayer/* 2>/dev/null || true
          rm -rf /tmp/zlayer-youki-e2e-test 2>/dev/null || true

  # ===========================================
  # E2E Tests (WASM)
  # ===========================================
  wasm-e2e-tests:
    name: E2E Tests (WASM)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha || inputs.sha || github.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libseccomp-dev

      - name: Run WASM E2E tests
        run: cargo test --package zlayer-agent --features wasm --test wasm_e2e_test -- --nocapture
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

  # ===========================================
  # E2E Tests (Docker)
  # ===========================================
  docker-e2e-tests:
    name: E2E Tests (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha || inputs.sha || github.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docker-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libseccomp-dev

      - name: Run Docker E2E tests
        run: cargo test --package zlayer-agent --features docker --test docker_runtime_test -- --nocapture
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

  # ===========================================
  # E2E Tests (Manager UI)
  # ===========================================
  manager-tests:
    name: E2E Tests (Manager)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha || inputs.sha || github.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-manager-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libseccomp-dev

      - name: Run Manager tests
        run: cargo test --package zlayer-manager --lib --features ssr -- --nocapture
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

  # ===========================================
  # macOS Unit Tests
  # Runs unit and doc tests on macOS to catch regressions in
  # macOS-specific code (#[cfg(target_os = "macos")]).
  # Linux-only tests are automatically excluded.
  # ===========================================
  macos-unit-tests:
    name: Unit Tests (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha || inputs.sha || github.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-macos-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: brew install protobuf

      - name: Run unit tests
        run: cargo test --workspace --lib --bins
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

      - name: Run doc tests
        run: cargo test --workspace --doc

  # ===========================================
  # E2E Tests (macOS Sandbox)
  # ===========================================
  macos-sandbox-e2e:
    name: E2E Tests (macOS Sandbox)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.sha || inputs.sha || github.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-macos-sandbox-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: brew install protobuf

      - name: Setup E2E environment
        run: |
          rm -rf /tmp/zlayer-macos-sandbox-e2e-test 2>/dev/null || true
          mkdir -p /tmp/zlayer-macos-sandbox-e2e-test/{data,logs}
          mkdir -p /tmp/zlayer-macos-sandbox-e2e-test/data/{containers,images}

      - name: Run macOS Sandbox E2E tests
        run: cargo test --package zlayer-agent --test macos_sandbox_e2e -- --nocapture
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/zlayer-macos-sandbox-e2e-test 2>/dev/null || true

  # ===========================================
  # Trigger Release (if version provided)
  # ===========================================
  trigger-release:
    name: Trigger Release
    runs-on: ubuntu-latest
    needs: [e2e-tests, wasm-e2e-tests, docker-e2e-tests, manager-tests, macos-unit-tests, macos-sandbox-e2e]
    if: github.event.client_payload.version != '' || inputs.version != ''
    steps:
      - name: Determine version
        id: version
        run: |
          VERSION="${{ github.event.client_payload.version || inputs.version }}"
          SHA="${{ github.event.client_payload.sha || inputs.sha || github.sha }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT

      - name: Trigger GitHub release workflow
        env:
          GH_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type": "create-release", "client_payload": {"version": "${{ steps.version.outputs.version }}", "sha": "${{ steps.version.outputs.sha }}"}}'

      - name: Summary
        run: |
          echo "## E2E Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: ${{ steps.version.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release workflow triggered." >> $GITHUB_STEP_SUMMARY
